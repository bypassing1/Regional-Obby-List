<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Obby Dashboard</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <link rel="stylesheet" href="style.css" />
</head>
<body style="background-color: #121212; background-image: none;">
    <div id="img"></div>
    <div class="dashboard-container">
        <!-- Banner with welcome message -->
        <div class="dashboard-banner">
            <h1>Welcome back, Username!</h1>
        </div>
        
        <!-- Stats Section -->
        <div class="dashboard-stats-container">
            <div class="dashboard-stat-card">
                <div class="dashboard-stat-title">Your Tier</div>
                <div class="dashboard-stat-value">0</div>
            </div>
            <div class="dashboard-stat-card">
                <div class="dashboard-stat-title">Obbies Completed</div>
                <div class="dashboard-stat-value">0</div>
            </div>
            <div class="dashboard-stat-card">
                <div class="dashboard-stat-title">Obbies Verified</div>
                <div class="dashboard-stat-value">0</div>
            </div>
            <div class="dashboard-stat-card">
                <div class="dashboard-stat-title">Global Ranking</div>
                <div class="dashboard-stat-value">#0</div>
            </div>
            <div class="dashboard-stat-card">
                <div class="dashboard-stat-title">Country Ranking</div>
                <div class="dashboard-stat-value">#0</div>
            </div>
            <div class="dashboard-stat-card">
                <div class="dashboard-stat-title">Hardest Obby</div>
                <div class="dashboard-stat-text">Daydream Valley</div>
            </div>
            <div class="dashboard-stat-card">
                <div class="dashboard-stat-title">List Point</div>
                <div class="dashboard-stat-value">0</div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="dashboard-action-buttons">
            <button class="dashboard-action-button primary" id="dashboard-submit-obby-btn">Submit Your Obby</button>
            <button class="dashboard-action-button" id="dashboard-submit-completion-btn">Submit Completion</button>
        </div>
        
        <!-- Search Bar -->
        <div class="dashboard-search-container">
            <input type="text" class="dashboard-search-bar" placeholder="Search for obbies...">
        </div>
        
        <!-- Games Grid -->
        <h2 class="dashboard-section-title">Obby Library</h2>
        <div class="dashboard-games-grid" id="dashboard-games-grid">
            <!-- Games will be added here by JavaScript -->
        </div>
    </div>
    
    <!-- Game Details Modal Popup -->
    <div class="dashboard-modal-overlay" id="dashboard-game-modal-overlay">
        <div class="dashboard-modal">
            <div class="dashboard-modal-header">
                <img src="/placeholder.svg" alt="" class="dashboard-modal-image" id="dashboard-modal-image">
                <h2 class="dashboard-modal-title" id="dashboard-modal-title"></h2>
                <div class="dashboard-modal-tier">Tier: <span id="dashboard-modal-tier"></span></div>
                <button class="dashboard-modal-close" id="dashboard-modal-close">×</button>
            </div>
            <div class="dashboard-modal-content">
                <div class="dashboard-players-list-title">Players who have beaten this obby</div>
                <div class="dashboard-players-list" id="dashboard-players-list">
                    <!-- Players will be added here by JavaScript -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Submit Obby Modal Popup -->
    <div class="dashboard-modal-overlay" id="dashboard-submit-obby-modal">
        <div class="dashboard-modal">
            <div class="dashboard-modal-header">
                <h2 class="dashboard-modal-title">Submit Your Obby</h2>
                <button class="dashboard-modal-close dashboard-submit-modal-close">×</button>
            </div>
            <div class="dashboard-modal-content">
                <form id="dashboard-submit-obby-form">
                    <div class="dashboard-form-group">
                        <label for="dashboard-obby-title" class="dashboard-form-label">Obby Title</label>
                        <input type="text" id="dashboard-obby-title" class="dashboard-form-input" placeholder="Enter your obby title" required>
                    </div>
                    <div class="dashboard-form-group">
                        <label for="dashboard-game-link" class="dashboard-form-label">Game Link</label>
                        <input type="url" id="dashboard-game-link" class="dashboard-form-input" placeholder="https://www.roblox.com/games/..." required>
                    </div>
                    <button type="submit" class="dashboard-form-submit">Submit Obby</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Submit Completion Modal Popup -->
    <div class="dashboard-modal-overlay" id="dashboard-submit-completion-modal">
        <div class="dashboard-modal">
            <div class="dashboard-modal-header">
                <h2 class="dashboard-modal-title">Submit Completion</h2>
                <button class="dashboard-modal-close dashboard-submit-modal-close">×</button>
            </div>
            <div class="dashboard-modal-content">
                <form id="dashboard-submit-completion-form">
                    <div class="dashboard-form-group">
                        <label for="dashboard-completion-title" class="dashboard-form-label">Obby Title</label>
                        <input type="text" id="dashboard-completion-title" class="dashboard-form-input" placeholder="Enter the obby you've beaten" required>
                    </div>
                    <div class="dashboard-form-group">
                        <label for="dashboard-video-link" class="dashboard-form-label">Video Proof Link</label>
                        <input type="url" id="dashboard-video-link" class="dashboard-form-input" placeholder="https://www.youtube.com/..." required>
                    </div>
                    <button type="submit" class="dashboard-form-submit">Submit Completion</button>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        // Function to open submit obby modal
        function openSubmitObbyModal() {
            document.getElementById('dashboard-submit-obby-modal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        // Function to open submit completion modal
        function openSubmitCompletionModal() {
            document.getElementById('dashboard-submit-completion-modal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        // Function to close any modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            document.body.style.overflow = ''; // Restore scrolling
        }
        
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const loggedInUser = localStorage.getItem('loggedInUser');
            if (!loggedInUser) {
                window.location.href = '/account';
            } else {
                const loggedInUser = localStorage.getItem('loggedInUser');
                document.querySelector('.dashboard-banner h1').textContent = `Welcome back, ${loggedInUser}!`;
                fetch('/api/get-roblox-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: loggedInUser })
                })
                .then(response => response.json())
                .then(data => {
                    if (!data || data.error) {
                        console.error(data.error || 'Unknown error');
                        return;
                    }
                    
                    const avatarUrl = data.avatarUrl;
                    console.log('Avatar URL:', avatarUrl);
                    
                    const banner = document.querySelector('.dashboard-banner');
                    if (banner && avatarUrl) {
                        banner.style.background = `linear-gradient(rgba(0, 0, 0, 0.5), rgba(115, 115, 115, 0.7)), url('${avatarUrl}') center/cover`;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            }
        });
    </script>
    <script>
        fetch('/api/listBlobs')
        .then(response => response.json())
        .then(data => {
            const globaldataBlob = data.blobs.find(blob => blob.pathname.startsWith('globaldata'));
            const obbiesBlob = data.blobs.find(blob => blob.pathname.startsWith('obbies'));
            const playerstatBlob = data.blobs.find(blob => blob.pathname.startsWith('playerstat'));
            
            if (!globaldataBlob || !obbiesBlob || !playerstatBlob) {
                throw new Error('Required blobs not found.');
            }
            
            return Promise.all([
            fetch(globaldataBlob.url).then(response => response.json()), // globaldata
            fetch(obbiesBlob.url).then(response => response.json()),     // obbies
            fetch(playerstatBlob.url).then(response => response.json())  // playerstat
            ]);
        })
        .then(([globaldata, obbies, playerstats]) => {
            const currentPlayerName = localStorage.getItem('loggedInUser');
            const currentPlayer = playerstats.find(p => p.name === currentPlayerName);
            if (!currentPlayer) return;
            
            // Assign points to globaldata obbies
            let points = 300;
            globaldata.forEach(entry => {
                entry.points = points.toFixed(2);
                points -= 2.77;
            });
            
            // Calculate total points for each player
            const playerPointsMap = playerstats.map(player => {
                let totalPoints = 0;
                player.beaten.forEach(obbyName => {
                    const globalObby = globaldata.find(entry => entry.title === obbyName);
                    if (globalObby) totalPoints += parseFloat(globalObby.points);
                });
                return { name: player.name, region: player.region, points: totalPoints };
            });
            
            // Sort players globally
            const globalRanking = [...playerPointsMap].sort((a, b) => b.points - a.points);
            const playerGlobalRank = globalRanking.findIndex(p => p.name === currentPlayerName) + 1;
            
            // Sort players by country
            const countryRanking = globalRanking.filter(p => p.region === currentPlayer.region);
            const playerCountryRank = countryRanking.findIndex(p => p.name === currentPlayerName) + 1;
            
            // Calculate individual stats
            let totalPoints = 0;
            let highestTier = 0;
            let hardestObby = 'None';
            let obbiesVerified = globaldata.filter(entry => entry.verifier === currentPlayerName).length;
            
            currentPlayer.beaten.forEach(obbyName => {
                const globalObby = globaldata.find(entry => entry.title === obbyName);
                const obbyInfo = obbies.find(entry => entry.title === obbyName);
                
                if (globalObby) totalPoints += parseFloat(globalObby.points);
                if (obbyInfo && obbyInfo.tier > highestTier) {
                    highestTier = obbyInfo.tier;
                    hardestObby = obbyInfo.title;
                }
            });
            
            // Update UI
            const statCards = document.querySelectorAll('.dashboard-stat-card');
            statCards.forEach(card => {
                const title = card.querySelector('.dashboard-stat-title').textContent.trim();
                const valueElement = card.querySelector('.dashboard-stat-value') || card.querySelector('.dashboard-stat-text');
                
                switch (title) {
                    case 'Your Tier':
                    valueElement.textContent = highestTier;
                    break;
                    case 'Obbies Completed':
                    valueElement.textContent = currentPlayer.beaten.length;
                    break;
                    case 'Obbies Verified':
                    valueElement.textContent = obbiesVerified;
                    break;
                    case 'Global Ranking':
                    valueElement.textContent = `#${playerGlobalRank}`;
                    break;
                    case 'Country Ranking':
                    valueElement.textContent = `#${playerCountryRank}`;
                    break;
                    case 'Hardest Obby':
                    valueElement.textContent = hardestObby;
                    break;
                    case 'List Point':
                    valueElement.textContent = totalPoints.toFixed(2);
                    break;
                }
            });
        })
        .catch(error => {
            console.error('Error loading data:', error);
        });
        
    </script>
    <script>
    const thumbnailCache = {};
    async function getThumbnailUrl(placeId) {
    if (thumbnailCache[placeId]) {
        console.log(`[Frontend] Cache hit for placeId: ${placeId}`);
        return thumbnailCache[placeId];
    }

    try {
        console.log(`[Frontend] Fetching thumbnail for placeId: ${placeId}`);
        const response = await fetch(`/api/thumbnail?placeId=${placeId}`);
        console.log('[Frontend] Response:', response);

        const data = await response.json();
        console.log('[Frontend] Response JSON:', data);

        const url = data?.thumbnails?.[0]?.thumbnails?.[0]?.imageUrl;

        if (url) {
            console.log(`[Frontend] Thumbnail URL found: ${url}`);
            thumbnailCache[placeId] = url;
            return url;
        } else {
            console.error('[Frontend] Thumbnail URL not found in response');
            return 'https://via.placeholder.com/512';
        }
    } catch (error) {
        console.error('[Frontend] Error fetching thumbnail:', error);
        return 'https://via.placeholder.com/512';
    }
}

        fetch('/api/listBlobs')
        .then(response => response.json())
        .then(data => {
            const obbiesBlob = data.blobs.find(blob => blob.pathname.startsWith('obbies'));
            const playerstatBlob = data.blobs.find(blob => blob.pathname.startsWith('playerstat'));
            
            if (!obbiesBlob || !playerstatBlob) {
                throw new Error('Required blobs not found.');
            }
            
            return Promise.all([
            fetch(obbiesBlob.url).then(response => response.json()),
            fetch(playerstatBlob.url).then(response => response.json())
            ]);
        })
        .then(async ([obbies, playerstats]) => {
            const games = await Promise.all(obbies.map(async obby => {
                const placeId = extractPlaceId(obby.gamelink);
                const image = placeId ? await getThumbnailUrl(placeId) : 'https://via.placeholder.com/512';
                return {
                    title: obby.title,
                    tier: obby.tier,
                    image: image,
                    players: playerstats
                        .filter(player => player.beaten.includes(obby.title))
                        .map(player => player.name)
                };
            }));

            renderGames(games);
        })
        .catch(error => console.error('Error loading data:', error));
        
        document.getElementById('dashboard-modal-close').addEventListener('click', () => closeModal('dashboard-game-modal-overlay'));

        document.getElementById('dashboard-game-modal-overlay').addEventListener('click', (e) => {
            if (e.target === document.getElementById('dashboard-game-modal-overlay')) {
                closeModal('dashboard-game-modal-overlay');
            }
        });
        
        document.getElementById('dashboard-submit-obby-btn').addEventListener('click', openSubmitObbyModal);
        
        document.getElementById('dashboard-submit-completion-btn').addEventListener('click', openSubmitCompletionModal);
        
        document.querySelectorAll('.dashboard-submit-modal-close').forEach(button => {
            button.addEventListener('click', function() {
                const modalId = this.closest('.dashboard-modal-overlay').id;
                closeModal(modalId);
            });
        });
        
        document.getElementById('dashboard-submit-obby-modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('dashboard-submit-obby-modal')) {
                closeModal('dashboard-submit-obby-modal');
            }
        });
        
        document.getElementById('dashboard-submit-completion-modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('dashboard-submit-completion-modal')) {
                closeModal('dashboard-submit-completion-modal');
            }
        });
        
        document.getElementById('dashboard-submit-obby-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const title = document.getElementById('dashboard-obby-title').value;
            const gameLink = document.getElementById('dashboard-game-link').value;
            
            checkmark('Obby submitted!' )
            
            this.reset();
            closeModal('dashboard-submit-obby-modal');
        });
        
        document.getElementById('dashboard-submit-completion-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const title = document.getElementById('dashboard-completion-title').value;
            const videoLink = document.getElementById('dashboard-video-link').value;
            
            // Here you would normally send this data to your server
            console.log('Completion submitted:', { title, videoLink });
            
            // Show success message (in a real app)
            alert(`Your completion of "${title}" has been submitted for verification!`);
            
            // Reset form and close modal
            this.reset();
            closeModal('dashboard-submit-completion-modal');
        });
        
        // Close modals with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (document.getElementById('dashboard-game-modal-overlay').classList.contains('active')) {
                    closeModal('dashboard-game-modal-overlay');
                }
                if (document.getElementById('dashboard-submit-obby-modal').classList.contains('active')) {
                    closeModal('dashboard-submit-obby-modal');
                }
                if (document.getElementById('dashboard-submit-completion-modal').classList.contains('active')) {
                    closeModal('dashboard-submit-completion-modal');
                }
            }
        });
        
        // Render games to the grid
        function renderGames(gamesList) {
            const gamesGrid = document.getElementById('dashboard-games-grid');
            gamesGrid.innerHTML = '';
            
            gamesList.forEach(game => {
                const gameCard = document.createElement('div');
                gameCard.className = 'dashboard-game-card';
                gameCard.dataset.title = game.title;
                
                gameCard.innerHTML = `
            <img src="${game.image}" alt="${game.title}" class="dashboard-game-image">
            <div class="dashboard-game-info">
                <div class="dashboard-game-title">${game.title}</div>
                <div class="dashboard-game-tier">Tier: <span>${game.tier}</span></div>
            </div>
        `;
                
                gameCard.addEventListener('click', () => openGameModal(game));
                gamesGrid.appendChild(gameCard);
            });
        }
        
        // Open the modal and show details
        function openGameModal(game) {
            const modalOverlay = document.getElementById('dashboard-game-modal-overlay');
            const modalImage = document.getElementById('dashboard-modal-image');
            const modalTitle = document.getElementById('dashboard-modal-title');
            const modalTier = document.getElementById('dashboard-modal-tier');
            const playersList = document.getElementById('dashboard-players-list');
            
            modalImage.src = game.image;
            modalTitle.textContent = game.title;
            modalTier.textContent = game.tier;
            playersList.innerHTML = '';
            
            if (game.players.length > 0) {
                game.players.forEach(player => {
                    const playerItem = document.createElement('div');
                    playerItem.textContent = player;
                    playersList.appendChild(playerItem);
                });
            } else {
                playersList.innerHTML = '<div>No players have beaten this obby yet.</div>';
            }
            
            modalOverlay.style.display = 'flex';
        }
        
        // Close modal
        document.getElementById('dashboard-modal-close').addEventListener('click', () => {
            document.getElementById('dashboard-game-modal-overlay').style.display = 'none';
        });
        
    </script>
    <script src="script/animation.js"></script>
    <script src=""></script>
</body>
</html>